name: harmony-api-fe-cd

on: push

jobs:
  deployment:
    name: Redeploy Services
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4    
        
      - name: SSH into azure VM and recreate existing backend
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.azureHost2 }}
          username: ${{ secrets.usernameDeployment }}
          password: ${{ secrets.passwordDeployment }}
          script_stop: true
          port: 22
          script: |
              az vm delete --name backend --resource-group all_devs --yes 
              az vm create --resource-group all_devs --name backend --image Ubuntu2204 --admin-username backend_user --admin-password ZDE7QNVXUJepLq9RmxXu --authentication-type password --os-disk-size-gb 30 --nic-delete-option detach --os-disk-delete-option delete --size Standard_B1ms --zone 1 --location canadacentral --nics backend-177_z1
              # To make sure that it is created and can be accessed and that docker services complete building
              sleep 30s

      - name: SSH into backend VM, setup backend
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.azureHost1 }}
          username: ${{ secrets.usernameBackend }}
          password: ${{ secrets.passwordBackend }}
          script_stop: false
          port: 22
          script: |
              # Add Docker's official GPG key:
              sudo apt-get update
              sudo apt-get install ca-certificates curl gnupg
              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              sudo chmod a+r /etc/apt/keyrings/docker.gpg

              # Add the repository to Apt sources:
              echo \
                "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
                "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
                sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update
                
              # Install Docker
              sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin --yes

              sudo apt install nginx --yes

              # Set Nginx settings 
              cd /etc/nginx/sites-enabled
              sudo rm default

              sudo echo "    	
                server {
                  listen 80 default_server;
                  listen [::]:80 default_server;

                  server_name _;

                  location / {
                            proxy_http_version 1.1;
                            proxy_set_header X-Forwarded-For \$remote_addr;
                            proxy_set_header Host \$host;
                            proxy_pass http://localhost:8080; 
                  }
                }" | sudo tee -a default

              # Apply Nginx Settings
              sudo systemctl restart nginx
      
      - name: Redeploy docker containers
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.azureHost1 }}
          username: ${{ secrets.usernameBackend }}
          password: ${{ secrets.passwordBackend }}
          script_stop: false
          port: 22
          script: |
              cd /etc/nginx/sites-enabled
              cat default
              
              sudo docker image pull aprovozin/harmony-api-cd:andrii-connect-db-cd
              sudo docker run -d -p 8081:8081 aprovozin/harmony-api-cd:andrii-connect-db-cd

              # let container api start
              sleep 10s

              sudo touch .env
              sudo echo "NEXT_PUBLIC_API_BASE_ENDPOINT=${{ secrets.azureHost1 }}:8081" >> .env

              sudo docker image pull aprovozin/harmony-fe-cd:andrii-connect-db-cd
              sudo docker run --env-file ./.env -d -p 8080:8080 aprovozin/harmony-fe-cd:andrii-connect-db-cd

              # let container fe start
              sleep 10s